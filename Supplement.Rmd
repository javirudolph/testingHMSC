---
title: "The Internal Structure of Metacommunities: Supplementary material"
author:
  - Mathew A. Leibold
  - Javiera Rudolph
  - Pedro Peres-Neto 
  - Dominique Gravel
  - Luc De Meester
  - Lauren Showmaker
  - Florian Hartig
  - F. Guillaume Blanchet
  - Jonathan M. Chase
output:
  html_document:
    toc: true
    toc_depth: 2

---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(tidyverse)
library(ggtern)
library(ggpubr)
library(reshape2)
```

```{r myFunctions, include = FALSE}

rastPlot <- function(data, title = "title", xlabel = "x", ylabel = "y"){
  ggplot(melt(data), aes(x = Var1, y = Var2, fill = value)) +
    geom_tile() +
    theme(axis.text = element_blank(),
          legend.title = element_blank()) +
    scale_fill_viridis_c(alpha = 0.5) +
    labs(title = title,
         x = xlabel,
         y = ylabel) +
    theme_bw()
}

```

# Description of Model and Simulation Scenarios

## Model Description
In our model, the metacommunity consists of $N$ patches distributed over a spatially heterogeneous landscape, with multiple environmental variables(although, the current simulations only have one environmental variable $D$ and 1000 patches) that could either be randomly distributed or spatially autocorrelated. Each patch has a set of coordinates in a two-dimensional space, and all possible coordinates are feasible such that this is a continuous space model that is not restricted to a lattice or some other kind of regular spatial arrangement of spatial units.  
```{r EnvSpa_variables}
set.seed(227)
# Random XY coordinates
# Each coordinate is drawn from a random uniform distribution
get_XY = function(N) cbind(runif(N),runif(N))

# Aggregation of XY coordinates
get_XY_agg = function(N, Nclusters, sd_xy) {
  
  Xclust = runif(Nclusters)
  Yclust = runif(Nclusters)
  
  X = rnorm(N, rep(Xclust,N/Nclusters), sd_xy)
  Y = rnorm(N, rep(Yclust,N/Nclusters), sd_xy)
  
  cbind(X,Y)
}

# Random uniform environmental values
get_E = function(D, N) matrix(runif(D*N), nr = N, nc = D)
```

The following example shows the scenario for 20 patches and one environmental variable. In the aggregated case, we determined four clusters. The value of the environmental variable for each patch is shown with the color hue. In this case, the environmental variable is randomly distributed.
```{r runEnvSpa}
N <- 20
D <- 1

rXY <- get_XY(N)
agXY <- get_XY_agg(N, 4, 0.02)
E <- get_E(D = D, N = N)
```


```{r plotEnvSpa, echo = FALSE, fig.height=3, fig.width=8}

plotData <- cbind.data.frame(rXY, agXY, E)
names(plotData) <- c("rX","rY", "agX", "agY", "E")

plot_rXY <- ggplot(plotData) +
  geom_point(aes(x = rX, y = rY, color = E), cex = 3) +
  labs(title = "Random patch locations",
       y = "Y coord",
       x = "X coord") +
  scale_color_viridis_c() +
  theme_classic()

plot_agXY <- ggplot(plotData) +
  geom_point(aes(x = agX, y = agY, color = E), cex = 3) +
  labs(title = "Aggregated patch locations",
       y = "Y coord",
       x = "X coord") +
  scale_color_viridis_c() +
  theme_classic()

ggarrange(plot_rXY, plot_agXY, legend = "right", common.legend = TRUE)



```



A patch may be empty, or be occupied by a single or by several species. We define $X_{i,z,t}$ as a stochastic variable representing the occurrence of species $i$ at location $z$ and time $t$. Occurrence, $X_{i,z,t}$, takes a value of 1 when species $i$ is present and a value of 0 when it is absent. Similarly, we define $\mathbb{Y}_{z,t}=X_{1,z,t},X_{2,z,t},…,X_{R,z,t}$ as a vector containing the presence-absence of each species from the regional pool  $R$.  
For example, to create the initial conditions, $t=0$,  of presence absence, species occupancy is drawn from a random uniform distribution, and values smaller than $0.8$ are considered as species presence. Patches or locations $z$ are represented by rows in the matrix, whereas each species is a column. Each cell in the matrix is $X_{i,z,t}$ and each row is $\mathbf{Y}_{z,t}$ for $t=0$. The following figure shows three different iterations of this process, where areas in black represent occupancy = 1, and white denotes an absence.

```{r initialCondMatrix, fig.height=3, fig.width=8}

#Get your initial conditions:
R <- 8
Y0 = matrix(0, nrow = N, ncol = R)
rand = matrix(runif(N*R), nr = N, nc = R)
Y0[rand < 0.8] = 1

ggplot(melt(Y0), aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "black")+
  labs(x = "Plot number", y = "Species") +
  theme_bw() +
  theme(legend.position = "none") -> A

R <- 8
Y0 = matrix(0, nrow = N, ncol = R)
rand = matrix(runif(N*R), nr = N, nc = R)
Y0[rand < 0.8] = 1

ggplot(melt(Y0), aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "black")+
  labs(x = "Plot number", y = "") +
  theme_bw() +
  theme(legend.position = "none") -> B

R <- 8
Y0 = matrix(0, nrow = N, ncol = R)
rand = matrix(runif(N*R), nr = N, nc = R)
Y0[rand < 0.8] = 1

ggplot(melt(Y0), aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "black")+
  labs(x = "Plot number", y = "") +
  theme_bw() +
  theme(legend.position = "none") -> C

ggarrange(A, B, C, ncol = 3)
  

```

The model only tracks the occupancy of the patches (not population densities). Spatial dynamics occurs because of colonization events, in both empty patches and patches that are occupied by other species, and because of extinction events. The emerging species co-distributions are a result of a dynamic balance between these events. Ecological interactions can impact either or both the colonization and the extinction probabilities. For instance, the presence of a competitor pre-empting a patch can reduce the colonization probability by another competitor. Alternatively, the presence of a competitor in a patch could increase the extinction probability of another species. Similarly, the environment could influence both the colonization and the extinction probabilities.

### Patch Colonization
We consider a discrete-time Markovian process to represent the dynamics of presence- absence of all species and we incorporate the effect of dispersal, environmental filtering and ecological interactions in such a way that we could cover all possible scenarios wherein species differ in any combination of ways. We include interspecific competition along with other types of spatial dynamics such as predator-prey interactions (Gravel et al. 2011), priority effects (Shurin et al. 2004), or mutualistic interactions (e.g. Gilarranz et al. 2015).
Following a colonization event from time $t$ to $t + \Delta$ corresponds to:
\begin{equation}
\tag{A1}
P(X_{i,z,t+\Delta t}=1│X_{i,z,t}=0)=I_{i,z,t} S_{i,z,t} C_{i,z,t}	
\end{equation}  
where $I_{i,z,t}$ is the number of immigrants of species $i$ reaching patch $z$ at time $t$, $S_{i,z,t}$ is the effect of environmental filtering on the probability of establishing a viable local population and $C_{i,z,t}$ is the effect of ecological interactions on the establishment probability. We note that because we represent a stochastic process, the product of these three functions has to be bounded between 0 and 1. We consequently define these quantities:  
The effect of immigration is given by:  
\begin{equation}
\tag{A2}
I_{i,z,t} = \frac{\sum k(z,\omega)X_{i,\omega,t}}{\sum k(z,\omega)}	
\end{equation}
which is a weighted average of the occurrence probability of species $i$ in the neighborhood of $z$. The function $k(z,\omega)$ is a dispersal kernel that depends on the location of patch $z$ and the neighborhood $\omega$. For convenience, we consider an exponential function of the Euclidean distance between localities. We add to the kernel a low distance and neighborhood-independent constant $m$ in order to account from immigration from outside the simulated metacommunity. This assumption is required to prevent total extinction by drift under perfectly neutral dynamics.
The effect of the environment is given by a product of the establishment performance over all environmental variables $E_n$:
\begin{equation}
\tag{A3}
S_{i,z,t} = \prod f(E_{n,z}\, \mu_{i,n}\, \sigma_{i,n})
\end{equation}
In our simulations, for convenience, we consider that the function $f$ has a quadratic form for all species and all environmental variables, though the model is flexible enough to consider other responses that also differ among species. 
To incorporate all possible ecological interactions, we start by representing the interaction network by a community matrix $\A of R species. The elements α_ij of A quantify the effect of species j on the dynamics of species i. When α_ij is negative, the colonization probability of species i decreases and/or its extinction probability increases when j is found locally. Inversely, when α_ij is positive, the colonization probability increases and/or the extinction probability decreases. To account for the cumulative effects of local interactions on transition probabilities, we make colonization and extinction probabilities community dependent. As explained above, at a time t, the Y_(z,t) vector gives the local assemblages. We calculate the sum of interactions at any time and for each species as ν=A_(z,t) Y_(z,t). Our approach can be interpreted as a spatial analogue to the generalized Lotka–Volterra model because it takes into account the impact of the whole network of interactions on each species dynamics and can deal with any type of interaction. We now define the function C_(i,z,t)=g(ν_i,z,t) representing the total effect of ecological interactions on the colonization probability. For convenience, we will use a sigmoid function, with g ranging between c_min at high negative interactions and c_max at high positive interactions. c_max should be interpreted as the maximal colonization probability when the environmental conditions are optimal and there is no dispersal limitations.

