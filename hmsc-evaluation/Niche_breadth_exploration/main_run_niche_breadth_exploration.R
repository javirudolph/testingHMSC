# MAIN RUN - GENERATE OUTPUT FILES
#   - This script will run the full process:
#         -from metacommunity simulation to model fitting and variation partitioning
#   - All figures associated with this output will be generated by a separate post-processing script.



# DESCRIPTION OF SIMULATIONS:
#   - Using 12 species with evenly spaced niche optima and varying niche breadth. 
#   - All species have the same niche breadth
#   - Variations include with/without species interactions, and gaussian or quadratic response to environment

main_fp <- "hmsc-evaluation/Niche_breadth_exploration/"
fp_quad_wout <- "hmsc-evaluation/Niche_breadth_exploration/quad_wout"
fp_quad_with <- "hmsc-evaluation/Niche_breadth_exploration/quad_with"
fp_gaus_wout <- "hmsc-evaluation/Niche_breadth_exploration/gaus_wout"
fp_gaus_with <- "hmsc-evaluation/Niche_breadth_exploration/gaus_with"


#     -If using HiperGator, you will provide the number of cores in the submission script
#         and can uncomment the following line.
# ncores <- as.numeric(Sys.getenv("SLURM_CPUS_PER_TASK"))
 

#     -If using a local computer, you can set the number of cores according to your local

ncores <- 10

# General Parameters ------------------------------------------------------

# To make things faster when testing different parameters, these are the ones we are playing with

niche_breadth <- seq(from = 0.4, to = 2, by = 0.2)
hmscPars <- list(niter = 30000, nburn = 5000, thin = 5)
dispersal <- 0.005


N <- 1000
D <- 1
R <- 12


fp <- c(fp_gaus_wout, fp_quad_wout, fp_gaus_with, fp_quad_with)
interaction.seq <- c(0, 0, 1.5, 1.5)

save.image(file = paste0(main_fp, "runInfo", ".RData"))

# No changes needed from here ---------------------------------------------

# LIBRARIES ---------------------------------------------------------------
library(tidyverse)
library(HMSC)
library(doParallel)

# FUNCTIONS ---------------------------------------------------------------

source("functions/prep_pars_fx.R")
source("functions/metacom_sim_fx.R")
source("functions/main_sim_fx.R")
source("functions/full_process_fx.R")


# ORIGINAL LANDSCAPE ------------------------------------------------------

XY <- readRDS("outputs/fixedLandscapes/orig-no-seed-XY.RDS")
E <- readRDS("outputs/fixedLandscapes/orig-no-seed-E.RDS")
MEMsel <- readRDS("outputs/fixedLandscapes/orig-no-seed-MEMsel.RDS")



# Process -----------------------------------------------------------------

for(i in 1:4){
  folderpath <- fp[i]
  val.inter <- interaction.seq[i]
  
  for(j in 1:length(niche_breadth)){
    namesrds <- paste0("scenario", j)
    
    pars <- prep_pars(N = N, D = D, R = R,
                      nicheOpt = NULL, breadth = niche_breadth[j], alpha = dispersal,
                      interx_col = val.inter, interx_ext = val.inter,
                      makeRDS = TRUE, whereToSave = folderpath, objName = namesrds)
    
    sims <- metacom_sim4HMSC(XY = XY, E = E, pars = pars,
                             nsteps = 200, occupancy = 0.8, niter = 5,
                             makeRDS = TRUE, whereToSave = folderpath, objName = namesrds)
    
    
    model <- metacom_as_HMSCdata(sims, numClusters = ncores, E = E, MEMsel = MEMsel,
                                 hmscPars = hmscParams,
                                 makeRDS = TRUE, whereToSave = folderpath, objName = namesrds)
    
    vpSpp <- get_VPresults(model, MEMsel = MEMsel, numClusters = ncores,
                           makeRDS = TRUE, whereToSave = folderpath, objName = namesrds)
    
    
    vpSites <- get_VPresults_SITE(model, MEMsel = MEMsel, numClusters = ncores,
                                  makeRDS = TRUE, whereToSave = folderpath, objName = namesrds)
    
    
  }
}

