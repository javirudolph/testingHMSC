# MAIN RUN - GENERATE OUTPUT FILES
#   - This script will run the full process:
#         -from metacommunity simulation to model fitting and variation partitioning
#   - All figures associated with this output will be generated by a separate post-processing script.



# DESCRIPTION OF SIMULATIONS:
#   - Using 12 species with evenly spaced niche optima and varying niche breadth. 
#   - All species have the same niche breadth
#   - Variations are done with the dispersal level

main_fp <- "hmsc-evaluation/Dispersal_exploration/"



#     -If using HiperGator, you will provide the number of cores in the submission script
#         and can uncomment the following line.
# ncores <- as.numeric(Sys.getenv("SLURM_CPUS_PER_TASK"))
 

#     -If using a local computer, you can set the number of cores according to your local

ncores <- 10

# General Parameters ------------------------------------------------------

# To make things faster when testing different parameters, these are the ones we are playing with

niche_breadth <- seq(from = 0.4, to = 2, by = 0.2)
hmscPars <- list(niter = 30000, nburn = 5000, thin = 5)

dispersal.seq <- rep(c(0.001, 0.005, 0.01, 0.05, 0.1),2)
interaction.seq <- c(rep(0, 5), rep(1.5, 5))
fp <- c("lo_disp_wout", "med_disp_wout", "hi1_disp_wout", "hi2_disp_wout", "hi3_disp_wout",
        "lo_disp_with", "med_disp_with", "hi1_disp_with", "hi2_disp_with", "hi3_disp_with")

for(i in 1:20){
  dir.create(paste0(main_fp, fp))
}


N <- 1000
D <- 1
R <- 12




save.image(file = paste0(main_fp, "runInfo", ".RData"))

# No changes needed from here ---------------------------------------------

# LIBRARIES ---------------------------------------------------------------
library(tidyverse)
library(HMSC)
library(doParallel)

# FUNCTIONS ---------------------------------------------------------------

source("functions/prep_pars_fx.R")
source("functions/metacom_sim_fx.R")
source("functions/main_sim_fx.R")
source("functions/full_process_fx.R")


# ORIGINAL LANDSCAPE ------------------------------------------------------

XY <- readRDS("outputs/fixedLandscapes/orig-no-seed-XY.RDS")
E <- readRDS("outputs/fixedLandscapes/orig-no-seed-E.RDS")
MEMsel <- readRDS("outputs/fixedLandscapes/orig-no-seed-MEMsel.RDS")



# Process -----------------------------------------------------------------

for(i in 1:length(fp)){
  folderpath <- paste0(main_fp, fp[i], "/")
  dispersal <- dispersal.seq[i]
  val.inter <- interaction.seq[i]
  
  for(j in 1:length(niche_breadth)){
    namesrds <- paste0("scenario", j)
    
    pars <- prep_pars(N = N, D = D, R = R,
                      nicheOpt = NULL, breadth = niche_breadth[j], alpha = dispersal,
                      interx_col = val.inter, interx_ext = val.inter,
                      makeRDS = TRUE, whereToSave = folderpath, objName = namesrds)
    
    sims <- metacom_sim4HMSC(XY = XY, E = E, pars = pars,
                             nsteps = 200, occupancy = 0.8, niter = 5,
                             makeRDS = TRUE, whereToSave = folderpath, objName = namesrds)
    
    
    model <- metacom_as_HMSCdata(sims, numClusters = ncores, E = E, MEMsel = MEMsel,
                                 hmscPars = hmscParams,
                                 makeRDS = TRUE, whereToSave = folderpath, objName = namesrds)
    
    vpSpp <- get_VPresults(model, MEMsel = MEMsel, numClusters = ncores,
                           makeRDS = TRUE, whereToSave = folderpath, objName = namesrds)
    
    
    vpSites <- get_VPresults_SITE(model, MEMsel = MEMsel, numClusters = ncores,
                                  makeRDS = TRUE, whereToSave = folderpath, objName = namesrds)
    
    
  }
}

